Создаем таблицу с текстовым полем и заполняем её 1 млн строк

```sql
create table mega_table (
     id serial primary key,
     random_text text
);
```

```sql
insert into mega_table (random_text)
select md5(random()::text) from generate_series(1, 1000000);
```

Смотрим размер файла с таблицей


```sql
select pg_size_pretty(pg_total_relation_size('mega_table'));
```

87 мегабайт

5 раз обновляем все строки, добавляя к каждой строке по символу. Это можно делать вручную

```sql
update large_text_table set text_field = text_field || 'Z';
```

Или использовать анонимную процедуру.

```sql
do $$
declare
    i integer := 1;
begin
    while i <= 5 loop
        update mega_table set random_text = random_text || 'Z';
        i := i + 1;
    end loop;
end $$;

```

Проверяем размер таблицы, а также кол-во "мертвых" строк и когда был последний автовакуум

```sql
select relname, n_dead_tup, last_autovacuum
from pg_stat_all_tables
where relname = 'mega_table';
```

Делаем это сразу после обновления таблицы и спустя некоторое время.
Сразу после - 492 мегабайта, 5 000 000 мертвых строк, 14:34:04
Спустя 2 минуты - 492 мегабайта, 0 мертвых строк, timestamp 14:36:37

Снова 5 раз обновляем все строки вручную или используя анонимную процедуру, и проверяем:
Сразу после - 524 мегабайта, 5 000 000 мертвых строк, 14:36:37
Спустя 4 минуты - 524 мегабайта, 0 мертвых строк, 14:40:58


Отключяем автовакуум на нашей таблице

```sql
alter table mega_table set (autovacuum_enabled = false);
```

10 раз обновляем все строки и, спустя некоторое время, смотрим размер таблицы, количество мертвых строк и время последнего автовакуума.
Сразу после - 1008 мегабайт, 10 000 000 мертвых строк, 14:40:58
Спустя 10 минут - 1008 мегабайт, 10 000 000 мертвых строк, 14:40:58

Вывод:

1) Увеличение размера таблицы связано с тем, что при обновлении строк PostgreSQL не перезаписывает существующие данные, а создает новые версии строк, помечая старые как "мертвые". Эти мертвые строки накапливаются в таблице, что приводит к значительному росту ее размера на диске.
2) PostgreSQL управляет данными на уровне страниц (блоков) размером 8 КБ. Когда происходит обновление, если на странице есть достаточно свободного места, новая версия строки записывается на эту же страницу, что позволяет не увеличивать размер таблицы. Но если страница заполнена, для новой версии строки выделяется дополнительное место, и таблица растет в размере. Поэтому размер таблицы увеличивается скачками, а не прямолинейно с увеличением объема данных.
3) Автовакуум — это процесс, который автоматически удаляет мертвые строки и освобождает место для дальнейшего использования. Однако важно понимать, что вакуум не возвращает это место обратно в файловую систему — оно остается выделенным за таблицей для будущих вставок или обновлений. Поэтому даже если мы удалим все записи из таблицы, без вакуума место освобождено не будет. Это важно учитывать когда мы, например, добавляем потенциально длинные транзакции и блокировки в высоко-нагруженной базе, что может помешать работе вакуума.
